name: Test Coverage

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    env:
      MIN_COVERAGE: ${{ vars.MIN_COVERAGE || '80' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: eCommApp/package-lock.json

      - name: Install dependencies
        working-directory: ./eCommApp
        run: npm ci

      - name: Run tests with coverage
        working-directory: ./eCommApp
        run: npm run test:coverage

      - name: Read coverage summary
        id: coverage
        working-directory: ./eCommApp
        run: |
          # Read coverage summary and extract all metrics in a single operation
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
            const total = data.total;
            
            // Output all metrics
            console.log('lines_pct=' + total.lines.pct);
            console.log('statements_pct=' + total.statements.pct);
            console.log('branches_pct=' + total.branches.pct);
            console.log('functions_pct=' + total.functions.pct);
          " >> $GITHUB_OUTPUT

      - name: Check coverage threshold
        working-directory: ./eCommApp
        run: |
          # Minimum coverage threshold from env variable (defaults to 80)
          MIN_COVERAGE=${{ env.MIN_COVERAGE }}
          LINES_PCT=${{ steps.coverage.outputs.lines_pct }}
          
          echo "Current lines coverage: $LINES_PCT%"
          echo "Minimum required coverage: $MIN_COVERAGE%"
          
          # Compare using bc for floating point comparison
          if (( $(echo "$LINES_PCT < $MIN_COVERAGE" | bc -l) )); then
            echo "âŒ Coverage is below the minimum threshold of $MIN_COVERAGE%"
            exit 1
          else
            echo "âœ… Coverage meets the minimum threshold"
          fi

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@v7
        with:
          script: |
            const linesPct = '${{ steps.coverage.outputs.lines_pct }}';
            const statementsPct = '${{ steps.coverage.outputs.statements_pct }}';
            const branchesPct = '${{ steps.coverage.outputs.branches_pct }}';
            const functionsPct = '${{ steps.coverage.outputs.functions_pct }}';
            
            // Create color badges based on coverage percentage
            const getColorBadge = (pct) => {
              const value = parseFloat(pct);
              if (value >= 90) return 'ðŸŸ¢';
              if (value >= 80) return 'ðŸŸ¡';
              if (value >= 70) return 'ðŸŸ ';
              return 'ðŸ”´';
            };
            
            const comment = `## ðŸ“Š Test Coverage Report
            
            ### Overall Coverage: ${getColorBadge(linesPct)} **${linesPct}%**
            
            | Metric | Coverage | Status |
            |--------|----------|--------|
            | **Statements** | ${statementsPct}% | ${getColorBadge(statementsPct)} |
            | **Branches** | ${branchesPct}% | ${getColorBadge(branchesPct)} |
            | **Functions** | ${functionsPct}% | ${getColorBadge(functionsPct)} |
            | **Lines** | ${linesPct}% | ${getColorBadge(linesPct)} |
            
            ### Coverage Status Legend
            - ðŸŸ¢ Excellent (â‰¥90%)
            - ðŸŸ¡ Good (â‰¥80%)
            - ðŸŸ  Fair (â‰¥70%)
            - ðŸ”´ Needs Improvement (<70%)
            
            ---
            
            *This report was automatically generated by the test coverage workflow.*
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“Š Test Coverage Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: eCommApp/coverage/
          retention-days: 30
